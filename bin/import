#!/bin/bash

# Configuration
DB_NAME="postgres"
DB_USER="postgres"
DB_PASSWORD="postgres"
SQL_FILE="/home/rodrigo/Downloads/dev-20241008T080001.sql"

# Export password to avoid it showing in process list
export PGPASSWORD="$DB_PASSWORD"

echo "Starting database recreation process..."

# Step 1: Clean up any remaining objects and terminate connections
echo "Cleaning up any remaining objects in database '$DB_NAME'..."
sudo -u postgres psql "$DB_NAME" <<EOF
-- Drop all objects in public schema more aggressively
DROP SCHEMA IF EXISTS public CASCADE;
CREATE SCHEMA public;
GRANT ALL ON SCHEMA public TO postgres;
GRANT ALL ON SCHEMA public TO public;
EOF

# Step 2: Terminate all connections to the target database
echo "Terminating existing connections to database '$DB_NAME'..."
sudo -u postgres psql -c "
SELECT pg_terminate_backend(pg_stat_activity.pid)
FROM pg_stat_activity
WHERE pg_stat_activity.datname = '$DB_NAME'
  AND pid <> pg_backend_pid();"

# Step 2: Drop the database
echo "Dropping database '$DB_NAME'..."
sudo -u postgres psql -c "DROP DATABASE IF EXISTS $DB_NAME;"

# Step 3: Create a new database
echo "Creating new database '$DB_NAME'..."
sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER $DB_USER;"

# Step 4: Import the SQL file
echo "Importing data from '$SQL_FILE'..."
if [ -f "$SQL_FILE" ]; then
    sudo -u postgres psql "$DB_NAME" < "$SQL_FILE"
    echo "Database recreation completed successfully!"
else
    echo "Error: SQL file '$SQL_FILE' not found!"
    exit 1
fi

# Clean up
unset PGPASSWORD
